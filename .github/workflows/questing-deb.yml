name: Build Questing .deb
on:
  workflow_dispatch:
  push:
    branches:
      - gh-actions
    tags:
      - 'v*'

jobs:
  build-questing-deb:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:questing
    steps:
      - name: Install build dependencies
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            build-essential \
            debhelper \
            dpkg-dev \
            dh-make \
            fakeroot \
            python3 \
            python3-jinja2 \
            jq \
            git \
            ca-certificates \
            nodejs \
            npm
          npm install -g yarn

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Prepare debian packaging
        run: |
          rm -rf debian
          cp -R packaging/ubuntu-questing debian
          python3 - <<'PY'
          import json
          from pathlib import Path
          from jinja2 import Template

          manifest = json.loads(Path("manifest.json").read_text())
          context = {
              "name": manifest["name"],
              "author": manifest["author"],
              "description": manifest["description"],
              "git_url": manifest["git_url"],
              "architecture": manifest["architecture"],
              "dependencies": {"ubuntu_common": manifest["dependencies"]["ubuntu_common"]},
          }

          def render(src, dest):
              template = Template(Path(src).read_text())
              Path(dest).write_text(template.render(**context))

          render("debian/control.j2", "debian/control")
          render("debian/copyright.j2", "debian/copyright")
          Path("debian/control.j2").unlink()
          Path("debian/copyright.j2").unlink()
          PY

      - name: Build .deb
        run: |
          dpkg-buildpackage -us -uc -b

      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          shopt -s nullglob
          for file in ../*.deb ../*.changes ../*.buildinfo; do
            mv "$file" artifacts/
          done

      - name: Smoke install
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends ./artifacts/*.deb
          test -f /usr/share/cockpit/cockpit-file-sharing/manifest.json

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: questing-deb
          path: artifacts/*
          if-no-files-found: error
